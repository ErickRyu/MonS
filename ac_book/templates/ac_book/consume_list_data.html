{% extends 'ac_book/base.html' %}
{% block content %}
    <script>
    var getCookie = function(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };

    var renderItem = function(data){
        /*
        input
            {
                pk: 41,
                fields: {
                    con_type: c1,
                    store_name: s1,
                    con_date: 2016 - 10 - 07 T08: 46: 38 Z,
                    con_price: 1111,
                    user: 16
                }
            }
        */
        var format = $('div[id=consume_show_format]').html();
        format = format.replace(/%con_type%/gi, data.fields.con_type);
        format = format.replace(/%consume_pk%/gi, data.pk);
        format = format.replace(/%store_name%/gi, data.fields.store_name);
        format = format.replace(/%con_price%/gi, data.fields.con_price);
        format = format.replace(/%con_date%/gi, dateFormat(data.fields.con_date, 'yyyy년 mm월 dd일, HH:MM'));

        $('div[id=consume_list]').append(format);
    };

    var renderItems = function(data){
        $('div[id=consume_list]').empty();
        for(var i in data)
            renderItem(data[i]);
    };

    var consumeOnClick = function(store_name){
        //modal test
        $('#myModal').modal();
        $(".modal-header #store_name").text( store_name);
    };

    var getConsumeWithTerm = function(start_date, end_date, inner_func){
        $.ajax({
            url : 'consume/' + start_date + '-' + end_date,
            method : 'GET',
            success : function(msg){
                inner_func(JSON.parse(msg));
            }
        });
    };

    var dateFormat = function(data, format){
        /*
            data : yyyy-mm-ddTHH:MM:SS
        */
        var year = data.substring(0, 4);
        var month = data.substring(5, 7);
        var date = data.substring(8, 10);
        var hour = data.substring(11, 13);
        var minute = data.substring(14, 16);
        var second = data.substring(17, 19);

        format = format.replace(/yyyy/gi, year);
        format = format.replace(/mm/gi, month);
        format = format.replace(/dd/gi, date);
        format = format.replace(/HH/gi, hour);
        format = format.replace(/MM/gi, minute);
        format = format.replace(/SS/gi, second);
        return format;
    };

    $(function(){
        var csrftoken = getCookie('csrftoken');
        $.ajax({
            url : '/consume/list/',
            method : 'POST',
            dataType: 'json',
            beforeSend : function(xhr){
                xhr.setRequestHeader("X-CSRFToken", csrftoken); 
            },
            success : function(msg){
                /*
                render data into template
                input
                    {
                        consumes : consume list
                    }
                */
                var msg_data = JSON.parse(msg);
                for(var i in msg_data){
                    renderItem(msg_data[i]);
                }
            }
        });
    });

    </script>


    <input type="text" id="from_date" placeholder='YYYYMM'> </input> ~ 
    <input type="text" id="to_date" placeholder='YYYYMM'> </input>
    <input class='btn btn-md' style='background-color:#a6a6a6;color:white;' type="button" id="term_submit" value="Find it!" onclick="javascript:getConsumeWithTerm($('#from_date').val(), $('#to_date').val(), renderItems)" />



    <div class="list-group" id = "consume_list">
    </div>

    <div id='consume_show_format' style='display:none;'>
        <a href='javascript:consumeOnClick("%store_name%");' class='list-group-item'>
            <B>
                <div class="panel-group">
                    <div class='panel-heading' style='background-color:#b3b3b3;color:white;'>
                    <h1 class ='modal-title'>%store_name%</h1>
                    </div>
                    <div class='panel-body'>
                        <p>%con_type%</p>
                        <p>%con_date%</p>
                        <p>%con_price%</p>
                    </div>
                </div>
            </B>
            <input type='hidden' id='consume_pk' value='%consume_pk%' />
        </a>
    </div>

    <div id="myModal" class="modal fade" role="dialog">
      <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h1 class="modal-title" id='store_name'>
            </h1>
          </div>
          <div class="modal-body">
            
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>

      </div>
    </div>
{% endblock content %}